---
title: Caddy进行sni回落的xray reality代理方案
date: 2024-11-21 20:00:00
tags: [科学上网,VPS,sing-box,xray,reality,caddy,容器,podman]
category: [计算机技术]
lede: 科学上网系列(その一)
thumbnail: /img/caddy-sni-with-reality/122668460.jpg
---
## 前言  
本文采用集成L4插件的Caddy负责入站分流、sing-box容器作为vless+vision+reality协议组合的xray代理节点，旨在充分发挥Caddy自动签发证书的便利性与sing-box的代理协议配置多样性，为同时具有可靠代理和建站需求的服主提供更统一且灵活的部署思路。  

## 先决条件  
本文假定用户已自行购买IP无污染VPS和二级域名`mydomain.com`，搭建一站式博客+梯子的典型应用场景如下：  
* 使用Caddy申请通配符证书并选用子域`sub.mydomain.com`建设动态站，网页服务运行在`8080`端口   
* 如无特殊说明，本系列反代服务均采用低权限运行监听高位端口，由iptables转发标准http(s)请求。即80→8080、443→8443  

## 预期效果  
* 除开SSH之外服务器整体对外仅开放标准https端口(443)，自建站证书自动维护，网站可套CDN防护避免暴露真实IP地址  
* xray代理流量伪装成指向其他境外站点流量，保障流量意图隐匿且线路不经过CDN劣化  
* 代理服务端sing-box以podman容器(类docker)方式部署实现免接触自动更新，第一时间享受软件新功能特性  
* 关站或域名到期不影响代理  

## Caddy安装及配置   
### 定制部署Caddy   
由于sni回落依赖高级功能，您不能直接使用服务器发行版的包管理器安装Caddy而是必须在[官网](https://caddyserver.com/download?package=github.com%2Fmholt%2Fcaddy-l4)下载集成L4插件的预编译执行文件。如果您还需要使用通配符证书，应同时勾选对应DNS服务商的请求插件，在我的情形中它是`dns.providers.cloudflare`，需要在科赋锐网站上用电子邮箱`my@email.com`注册并获取`MY_API_TOKEN`用于完善配置。  
完成下载后需要将其上传至`/usr/local/bin`路径并按需配置执行权限，并将服务加入进程守护。  
```shell
sudo curl -o /etc/systemd/system/caddy.service  https://raw.githubusercontent.com/caddyserver/dist/refs/heads/master/init/caddy.service && sudo systemctl daemon-reload
```

### 编写Caddy配置文件  
创建配置文件中提到的系统日志`/log/path/error.log`、访问日志`/log/path/access.log`及Caddy配置文件：  
<details>
<summary><font color="#E02222">/etc/caddy/Caddyfile</font></summary>

```
{
    https_port 8443
    log {
        output file /log/path/error.log
        format console
        level error
    }
    admin off
    acme_dns cloudflare MY_API_TOKEN
    email my@email.com
    layer4 {
        :8443 {
            @reality tls sni itunes.apple.com
            route @reality {
                proxy {
                    upstream 127.0.0.1:7893
                }
            }
        }
    }
}
*.mydomain.com {
    encode gzip zstd
    log {
        output file /log/path/access.log
        format console
    }
    @sub host sub.mydomain.com
    handle @sub {
        ## website
        reverse_proxy 127.0.0.1:8080
        ## other services
        ## ...
    }
    ## Fallback for otherwise unhandled domains
    handle {
        abort
    }
}
```
</details>

### 性能调优  
开启BBR拥塞缓解算法  
```shell
echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf && echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf && sysctl -p && sysctl net.ipv4.tcp_congestion_control
```

### 防火墙适配
此处提供一个具备基础防护功能的iptables配置，它保留了22端口的ssh通信，同时接收443端口流量并转发至服务器内部Caddy监听的8443端口：  
<details>
<summary><font color="#E02222">/etc/iptables.rules</font></summary>

```
# Generated by iptables-save v1.8.7 on Thu Jun 16 22:39:34 2022
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A PREROUTING -p tcp -m tcp --dport 8443 -j MARK --set-xmark 0x1/0xffffffff
-A PREROUTING -p udp -m udp --dport 8443 -j MARK --set-xmark 0x1/0xffffffff
COMMIT
# Completed on Thu Jun 16 22:39:34 2022
# Generated by iptables-save v1.8.7 on Thu Jun 16 22:39:34 2022
*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -m mark --mark 0x1 -j DROP
-A INPUT -p tcp -m multiport --dports 22,8443 -j ACCEPT
-A INPUT -p udp -m multiport --dports 8443 -j ACCEPT
# Completed on Thu Jun 16 22:39:34 2022
# Generated by iptables-save v1.8.7 on Thu Jun 16 22:39:34 2022
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A PREROUTING -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 8443
-A PREROUTING -p udp -m udp --dport 443 -j REDIRECT --to-ports 8443
COMMIT
# Completed on Thu Jun 16 22:39:34 2022
```
</details>

如果您不打算使用端口重定向方式而是希望Caddy直接接管443端口，请忽略本小节内容并将`caddy.json`文件中所有的8443端口改为443即可： 
```shell
sudo sed -i 's/8443/443/g' /etc/caddy/Caddyfile
```

## sing-box安装及配置  
#### 以容器(podman)方式部署  
podman是一种兼容docker镜像的容器管理工具，较新的科学上网工具通常不会提供各发行版的软件源，但基本都维护更新docker镜像。podman本身亦具备一键更新命令`podman auto-update`且支持自动化定期执行，适合无人值守环境。  
要通过podman部署容器，首先需要安装它。在Debian-based发行版中的安装命令是`sudo apt install podman`，之后使用高度类似`docker create`的语法部署容器：  
```shell
sudo podman create -it --name singbox --restart=unless-stopped --label io.containers.autoupdate=image --network=host --tz=Asia/Shanghai --volume /etc/singbox:/etc/sing-box:z --volume ~/.local/share/caddy/certificates/:/etc/ssl/private:z ghcr.io/sagernet/sing-box:latest -D /var/lib/sing-box -C /etc/sing-box/ run
sudo podman generate systemd --new --name singbox > /etc/systemd/system/container-singbox.service && sudo systemctl daemon-reload
```

我们在sing-box的默认参数之外还添加了容器对宿主服务器证书路径的访问，这是因为sing-box在实现部分代理协议时可以利用到Caddy自签证书，尽管对于reality来说并不是必须的。  
如果您不喜欢podman，请忽略本小节内容并遵循sing-box[官方文档](https://sing-box.sagernet.org/zh/installation/package-manager/)完成安装。  

#### 服务端配置  
以下配置将实现在`7893`端口上监听xray的代理请求，协议组合为时下抗检测能力较强的vless+vision+reality，降低流量特征并伪造访问意图指向了合规境外站点`itunes.apple.com`；具备简单的全局路由防呆，拒绝响应目标地址为本地IP、大陆站点请求及一切bt下载。  
要使用该模板，您需要补全`uuid`、使用`./xray x25519`命令生成`private_key`。  
<details>
<summary><font color="#E02222">/etc/singbox/config.json</font></summary>

```json
{
    "log": {
        "disabled": false,
        "level": "error",
        "output": "/your/log/path/box.log",
        "timestamp": true
    },
    "inbounds": [{
        "tag": "reality-in",
        "type": "vless",
        "listen": "::",
        "listen_port": 7893,
        "sniff": true,
        "users": [{
            "uuid": "MY_UUID",
            "flow": "xtls-rprx-vision"
        }],
        "tls": {
            "enabled": true,
            "server_name": "itunes.apple.com",
            "reality": {
                "enabled": true,
                "handshake": {
                    "server": "itunes.apple.com",
                    "server_port": 443
                },
                "private_key": "MY_PRIVATE_KEY",
                "short_id": [""]
            }
        }
    }],
    "outbounds": [
        {
            "tag": "direct",
            "type": "direct"
        },
        {
            "tag": "block",
            "type": "block"
        }
    ],
    "route": {
        "rule_set": [
            {
                "type": "remote",
                "tag": "geoip-cn",
                "format": "binary",
                "url": "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/sing/geo/geoip/cn.srs",
                "download_detour": "direct"
            },
            {
                "type": "remote",
                "tag": "geosite-cn",
                "format": "binary",
                "url": "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/sing/geo/geosite/cn.srs",
                "download_detour": "direct"
            }
        ],
        "rules": [{
            "type": "logical",
            "mode": "or",
            "rules": [{"rule_set": ["geoip-cn","geosite-cn"]},{"ip_is_private": true},{"protocol": ["bittorrent"]}],
            "invert": false,
            "outbound": "block"
        }],
        "final": "direct"
    }
}
```
</details>

#### 客户端配置
因不同平台客户端配置方式各异，此处仅展示节点分享链。您需要补全与`config.json`文件中相同的`MY_UUID`、服务器的实际IP`MY_SERVER_IP`、用`./xray x25519 -i "MY_PRIVATE_KEY"`命令生成公钥`MY_PUBLIC_KEY`，通过剪贴板导入客户端。  
```
vless://MY_UUID@MY_SERVER_IP:443?allowInsecure=false&flow=xtls-rprx-vision&fp=chrome&headerType=none&pbk=MY_PUBLIC_KEY&security=reality&sni=itunes.apple.com&type=tcp
```

## 完成！  
校核配置文件无误后，启动Caddy与sing-box服务：  
```shell
sudo systemctl enable --now caddy.service && sudo systemctl enable --now container-singbox.service
```

## 方案缺陷(?)
#### dest质量
在实践中您也许会注意到，由于境内CDN节点的存在以及服务器落地位置差异等因素，`itunes.apple.com`不一定是最合适的伪装对象，甚至有可能让自己的服务器成为CDN的反代加速节点。请参考[官方建议](https://github.com/XTLS/Xray-core/discussions/2256)及[其他文章](https://www.smallstep.one/article/reality-domain)评估您的伪装站点。  

#### 保持学习  
sing-box是一款锐意开发的通用代理平台，每次迭代引入新的功能特性都伴随着不同程度的[调整](https://sing-box.sagernet.org/zh/migration/)和[淘汰](https://sing-box.sagernet.org/zh/deprecated/)，您需要持续跟进了解以避免配置文件过时而失效(当然抛开这一点，反网路審查本身就需要这么做)，或者关闭podman自动更新。  

#### Caddy更新缺乏便利性手段
定制集成功能的Caddy无法享受标准包的维护更新，作为http服务的重要环节，您需要不断手动生成可执行文件或额外架设自动编译服务以引入上游的安全补丁。  
